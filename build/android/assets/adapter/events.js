var Moment=require("vendor/moment");const DB=Ti.App.Properties.getString("DATABASE");var Module=function(){this.eventhandlers={};var e=Ti.Database.open(DB);return e&&(e.execute("CREATE TABLE IF NOT EXISTS events (date TEXT,eventid TEXT UNIQUE,locationId TEXT,title TEXT, description TEXT,imageToken TEXT,locationName TEXT,locationStreet TEXT, locationPlz TEXT, locationCity TEXT,categoryId NUMBER,displayDate TEXT,featured TEXT)"),e.execute("CREATE TABLE IF NOT EXISTS locations (id TEXT UNIQUE,locationName TEXT,street TEXT,plz TEXT,city TEXT,teaserTextGerman TEXT,imageToken TEXT,url TEXT,latitude NUMBER,longitude NUMBER,accessibilityType TEXT,accessibilityText TEXT,hvvStops TEXT,handicappedParking TEXT,stadtrad TEXT)"),e.execute("CREATE TABLE IF NOT EXISTS days (day TEXT UNIQUE,hash TEXT,size NUMBER,mtime NUMBER)"),e.close()),e.close(),this.loadLocations(),this};Module.prototype={getLocationById:function(e){var t=Ti.Database.open(DB),o=t.execute("SELECT * FROM locations WHERE id=?",e),a={};if(o.isValidRow())for(var n=o.getFieldCount(),i=0;n>i;i++)a[o.getFieldName(i)]=o.field(i);return o.close(),t.close(),a},loadLocations:function(){var e=this,t=Ti.Network.createHTTPClient({timeout:3e4,onload:function(){if(200==this.status){var o=JSON.parse(this.responseText),a=Ti.Database.open(DB);a.execute("BEGIN"),o.locations.forEach(function(e){a.execute("INSERT OR REPLACE INTO locations VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)",""+e.id,e.locationName,e.street,e.plz,e.city,e.teaserTextGerman,e.imageToken,e.url,e.latitude,e.longitude,e.accessibilityType,e.accessibilityText,e.hvvStops,e.handicappedParking,e.stadtrad)}),a.execute("COMMIT"),a.close(),Ti.App.Properties.setString("location",t.getResponseHeader("ETag"))}e.fireEvent("locationsready")},onerror:function(){console.log(this.error)}}),o=Ti.App.Properties.getString("ENDPOINT")+"locations";t.open("GET",o),Ti.App.Properties.hasProperty("location")&&t.setRequestHeader("If-None-Match",Ti.App.Properties.getString("location")),t.setRequestHeader("Accept-Type","application/json"),t.setRequestHeader("Accept","application/json"),t.send()},getEventsByLocation:function(e){for(var t=Ti.Database.open(DB),o=t.execute("SELECT * FROM `events` WHERE events.locationId=? AND date>=? ORDER BY `date`",e,Moment().format("YYYY-MM-DD")),a=[];o.isValidRow();){for(var n=o.getFieldCount(),i={},s=0;n>s;s++)i[o.getFieldName(s)]=o.field(s);a.push(i),o.next()}o.close(),t.close();var r={};return a.forEach(function(e){r[e.date]||(r[e.date]=[]),r[e.date].push(e)}),a},getLocationsByDay:function(e){for(var t=Ti.Database.open(DB),o=t.execute("SELECT events.*,locations.*  FROM events,locations WHERE events.locationId=locations.id AND events.date=?",e||Moment().format("YYYY-MM-DD")),a=[];o.isValidRow();){for(var n=o.getFieldCount(),i={},s=0;n>s;s++)i[o.getFieldName(s)]=o.field(s);a.push(i),o.next()}return o.close(),t.close(),a},getEventsofDay:function(e){for(var t=Ti.App.Properties.getList("selectedcategories",[1,2,3,4,5,6,7]),o=[],a=Ti.Database.open(DB),n=a.execute("SELECT * FROM events WHERE date=? AND categoryID in ("+t.join(",")+")",e);n.isValidRow();){for(var i=n.getFieldCount(),s={},r=0;i>r;r++)s[n.getFieldName(r)]=n.field(r);o.push(s),n.next()}if(a.close(),o.length){var c={1:[],2:[],3:[],4:[],5:[],6:[],7:[]};return o.forEach(function(e){c[e.categoryId].push(e)}),o.length>0&&this.fireEvent("eventsready",{events:o,categories:c}),!0}return!1},loadEventsofDay:function(e){var t=this,o=this.getEventsofDay(e);if(Ti.Network.online){var a=Ti.Network.createHTTPClient({timeout:3e4,onload:function(){var o=(new Date).getTime();if(console.log(e+"    status="+this.status+"      time="+((o-r)/1e3).toFixed(1)+"sec.    etag="+a.getResponseHeader("ETag")),200==this.status){var n=JSON.parse(this.responseText),i=Ti.Database.open(DB);i.execute("BEGIN"),n.eventsOfTheDay.forEach(function(t){i.execute("INSERT OR REPLACE INTO events VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?)",e,t.eventid,""+t.locationId,t.title,t.text,t.imageToken,t.locationName,t.locationStreet,t.locationPlz,t.locationCity,t.categoryId,t.displayDate,t.featured)}),i.execute("COMMIT"),i.execute("INSERT OR REPLACE INTO days VALUES (?,?,?,?)",e,a.getResponseHeader("ETag"),this.responseText.length,Moment().unix()),i.close()}t.getEventsofDay(e)},onerror:function(){console.log(this.error)}}),n=Ti.App.Properties.getString("ENDPOINT")+"daily?day="+e;a.open("GET",n),a.setRequestHeader("Accept-Type","application/json"),a.setRequestHeader("Accept","application/json"),a.setRequestHeader("Accept-Encoding","gzip, deflate");var i=Ti.Database.open(DB),s=i.execute("SELECT hash FROM days WHERE day=?",e);s.isValidRow()&&o&&a.setRequestHeader("If-None-Match",s.getFieldByName("hash")),s.close(),i.close(),a.send();var r=(new Date).getTime()}else this.fireEvent("eventsready",{error:!0,reason:"offline"})},fireEvent:function(e,t){if(this.eventhandlers[e])for(var o=0;o<this.eventhandlers[e].length;o++)this.eventhandlers[e][o].call(this,t)},addEventListener:function(e,t){this.eventhandlers[e]||(this.eventhandlers[e]=[]),this.eventhandlers[e].push(t)},removeEventListener:function(e,t){if(this.eventhandlers[e]){var o=this.eventhandlers[e].filter(function(e){return e!=t});this.eventhandlers[e]=o}}},module.exports=Module;