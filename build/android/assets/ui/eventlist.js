var Moment=require("vendor/moment"),truncate=function(e,a){var n,r;if(n=e.split(""),n.length>a){for(r=n.length-1;r>-1;--r)if(r>a)n.length=r;else if(" "===n[r]){n.length=r;break}n.push(" …")}return n.join("")};module.exports=function(e){function a(e){t.removeEventListener("itemclick",a),require("ui/event.window")(JSON.parse(e.itemId)).open(),Ti.Media.vibrate([0,5]),setTimeout(function(){t.addEventListener("itemclick",a)},200)}var n=new(require("adapter/events")),r=require("com.rkam.swiperefreshlayout"),i=[],t=Ti.UI.createListView({templates:{events:require("ui/TEMPLATES").events},sections:i,defaultItemTemplate:"events"}),c=r.createSwipeRefresh({view:t,height:Ti.UI.FILL,width:Ti.UI.FILL});return c.setRefreshing(!0),setTimeout(function(){c.setRefreshing(!1)},1e4),t.addEventListener("itemclick",a),n.addEventListener("eventsready",function(e){if(c.setRefreshing(!1),!e.error){var a=Ti.App.Properties.getString("categories").split(","),n=0;for(categoryId in e.categories)i[n]=Ti.UI.createListSection({headerTitle:a[n],items:e.categories[categoryId].map(function(e){return e.imageurl=e.imageToken?"http://www.kulturlotse.de/bild/l/x-"+e.imageToken+".jpg":"",e.text||(e.text=e.description||""),{properties:{itemId:JSON.stringify(e)},title:{text:e.title},text:{text:truncate(e.text.replace(/<br>/gi,"\n").replace(/(<([^>]+)>)/gi,""),96)},locationname:{text:e.locationName},locationstreet:{text:e.locationStreet},image:{image:e.imageurl}}})}),n++;t.setSections(i)}}),c.addEventListener("refreshing",function(){n.loadEventsofDay(Moment().add(e,"d").format("YYYY-MM-DD"),!0),setTimeout(function(){c.setRefreshing(!1)},1e4)}),n.loadEventsofDay(Moment().add(e,"d").format("YYYY-MM-DD")),Ti.App.addEventListener("categorieschanged",function(){n.getEventsofDay(Moment().add(e,"d").format("YYYY-MM-DD"))}),c};