var Moment=require("vendor/moment");Moment.locale("de");var GeoLocation=new(require("vendor/georoute")),Map=require("ti.map"),HVV=new(require("adapter/hvv")),region={latitude:53.56,longitude:10,latitudeDelta:.1,longitudeDelta:.1,limit:50};module.exports=function(){function e(e){function a(e){for(var a=0;a<r.hvvannotations.length;a++)if(r.hvvannotations[a].id==e)return!0;return!1}if(0==r.locked){r.locked=!0,setTimeout(function(){r.locked=!1},50);var n=(e.source,[]);HVV.getStations(e).forEach(function(e){if(!a(e.id)){var i=Map.createAnnotation({latitude:e.lat,longitude:e.lng,id:e.id,title:e.name,image:"/images/hvv.png"});r.hvvannotations.push(i),n.push(i)}}),r.mapView.addAnnotations(n)}else setTimeout(function(){r.locked=!1},50)}var a=arguments[0]||{},n=new(require("adapter/events")),r=Ti.UI.createWindow({fullscreen:!0,hvvannotations:[],day:Moment(a.date).format("DD.MM.YYYY")});r.mapView=Map.createView({region:region,animated:!0,enableZoomControls:!1,mapType:Map.NORMAL_TYPE});var i=Ti.UI.createView({top:0,height:20});return r.add(r.mapView),r.progress=require("com.rkam.swiperefreshlayout").createSwipeRefresh({view:i,height:20,top:0,width:Ti.UI.FILL}),r.add(r.progress),r.mapView.addEventListener("complete",function(){r.hvvannotations=HVV.getStations(r.mapView.region).map(function(e){return Map.createAnnotation({latitude:e.lat,longitude:e.lng,title:e.name,id:e.id,image:"/images/hvv.png"})}),r.mapView.addAnnotations(r.hvvannotations);var e=n.getLocationsByDay(a.day).map(function(e){return Map.createAnnotation({latitude:e.latitude,longitude:e.longitude,leftView:Ti.UI.createImageView({width:30,height:20,right:10,image:e.imageToken?"http://www.kulturlotse.de/bild/s/x-"+e.imageToken+".jpg":""}),image:"/images/map"+e.categoryId+".png",title:e.title,subtitle:e.locationName+", "+e.locationStreet})});r.mapView.addAnnotations(e),a.locationId&&(GeoLocation.addEventListener("latlng",function(e){var n=Map.createAnnotation({latitude:parseFloat(e.lat),longitude:parseFloat(e.lng),image:"/images/appicon.png",title:a.title,subtitle:a.locationStreet});r.mapView&&(r.mapView.addAnnotation(n),r.mapView.setLocation({latitude:parseFloat(e.lat),longitude:parseFloat(e.lng),latitudeDelta:.01,longitudeDelta:.01,animated:!0}),r.mapView.selectAnnotation(n))}),GeoLocation.getLatLng(a.locationPlz+" "+a.locationCity+","+a.locationStreet))}),r.addEventListener("open",require("ui/map.actionbar")),r.mapView.addEventListener("regionchanged",e),r.mapView.addEventListener("click",function(e){null!=e.clicksource&&e.annotation&&e.annotation.type&&console.log(e.annotation.type),r.locked=!0,setTimeout(function(){r.locked=!1;r.mapView.getRegion()},700)}),r};