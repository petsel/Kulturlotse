var Moment=require("vendor/moment");Moment.locale("de");var GeoLocation=new(require("vendor/georoute")),Map=require("ti.map"),HVV=new(require("adapter/hvv"));module.exports=function(){function e(a){c.mapView.removeEventListener("click",e),setTimeout(function(){c.mapView.addEventListener("click",e)},700),null!=a.clicksource&&a.annotation&&a.annotation.type&&"pin"!=a.clicksource&&(console.log(a.clicksource),a.annotation.type&&"car2go"==a.annotation.type&&(Ti.Media.vibrate([0,5]),require("ui/stations.window")({type:a.annotation.type}).open())),c.locked=!0,setTimeout(function(){c.locked=!1;c.mapView.getRegion()},700)}function a(e){function a(e){for(var a=0;a<c.hvvannotations.length;a++)if(c.hvvannotations[a].id==e)return!0;return!1}if(Ti.App.Properties.setString("LASTREGION",JSON.stringify({latitude:e.latitude,longitude:e.longitude,latitudeDelta:e.latitudeDelta,longitudeDelta:e.longitudeDelta})),0==c.locked){c.locked=!0,setTimeout(function(){c.locked=!1},50);var n=e.source;if(e.latitudeDelta>.2)return console.log(c.hvvannotations.length+" annotations removed"),n.removeAnnotations(c.hvvannotations),void(c.hvvannotations=[]);var r=[];HVV.getStations(e).forEach(function(e){if(!a(e.id)){var n=Map.createAnnotation({latitude:e.lat,longitude:e.lng,id:e.id,title:e.name,image:"/images/hvv.png"});c.hvvannotations.push(n),r.push(n)}}),c.mapView.addAnnotations(r)}else setTimeout(function(){c.locked=!1},50)}var n={latitude:53.56,longitude:10,latitudeDelta:.1,longitudeDelta:.1,limit:50};if(Ti.App.Properties.hasProperty("LASTREGION")){var r=JSON.parse(Ti.App.Properties.getString("LASTREGION"));n={latitude:r.latitude,longitude:r.longitude,latitudeDelta:r.latitudeDelta,longitudeDelta:r.longitudeDelta,limit:50}}var i=arguments[0]||{},t=new(require("adapter/events")),c=Ti.UI.createWindow({fullscreen:!0,hvvannotations:[],day:Moment(i.date).format("DD.MM.YYYY")});c.mapView=Map.createView({region:n,animate:!0,compassEnabled:!1,userLocation:!0,enableZoomControls:!1,userLocationButton:!0,mapType:Map.NORMAL_TYPE});var o=Ti.UI.createView({top:0,height:20});return c.add(c.mapView),c.progress=require("com.rkam.swiperefreshlayout").createSwipeRefresh({view:o,height:20,top:0,width:Ti.UI.FILL}),c.add(c.progress),c.mapView.addEventListener("complete",function(){c.hvvannotations=HVV.getStations(c.mapView.region).map(function(e){return Map.createAnnotation({latitude:e.lat,longitude:e.lng,title:e.name,id:e.id,image:"/images/hvv.png"})}),c.mapView.addAnnotations(c.hvvannotations);var e=t.getLocationsByDay(i.day).map(function(e){return Map.createAnnotation({latitude:e.latitude,longitude:e.longitude,leftView:Ti.UI.createImageView({width:30,height:20,right:10,image:e.imageToken?"http://www.kulturlotse.de/bild/s/x-"+e.imageToken+".jpg":""}),image:"/images/map"+e.categoryId+".png",title:e.title,subtitle:e.locationName+", "+e.locationStreet})});c.mapView.addAnnotations(e),i.locationId&&(GeoLocation.addEventListener("latlng",function(e){var a=Map.createAnnotation({latitude:parseFloat(e.lat),longitude:parseFloat(e.lng),image:"/images/appicon.png",title:i.title,subtitle:i.locationStreet});c.mapView&&(c.mapView.addAnnotation(a),c.mapView.setLocation({latitude:parseFloat(e.lat),longitude:parseFloat(e.lng),latitudeDelta:.01,longitudeDelta:.01,animated:!0}),c.mapView.selectAnnotation(a))}),GeoLocation.getLatLng(i.locationPlz+" "+i.locationCity+","+i.locationStreet))}),c.addEventListener("open",require("ui/map.actionbar")),c.mapView.addEventListener("regionchanged",a),c.mapView.addEventListener("click",e),c};